 ---
title: "P8105 Homework 6"
author: "Di Lian (dl3836)"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE
)
```

## Problem 1

```{r packages-p1}
library(tidyverse)
library(broom)
```

### Data cleaning

```{r clean-homicide}
homicide_df <- 
  read_csv("data/homicide-data.csv") %>%
  mutate(
    city_state = str_c(city, state, sep = ", "),
    resolved = case_when(
      disposition == "Closed by arrest" ~ 1,
      TRUE ~ 0
    ),
    victim_age = as.numeric(victim_age)
  ) %>%
  filter(
    !city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL"),
    victim_race %in% c("White", "Black")
  )
```

### Baltimore-specific model

```{r baltimore-glm}
baltimore_fit <- homicide_df %>%
  filter(city_state == "Baltimore, MD") %>%
  glm(resolved ~ victim_age + victim_sex + victim_race, family = binomial, data = .)

baltimore_or <- baltimore_fit %>%
  tidy(conf.int = TRUE, exponentiate = TRUE) %>%
  filter(term == "victim_sexMale") %>%
  select(term, estimate, conf.low, conf.high)

baltimore_or
```

### City-specific models

```{r city-models}
city_results <- homicide_df %>%
  nest(data = -city_state) %>%
  mutate(
    models = map(data, ~ glm(resolved ~ victim_age + victim_sex + victim_race, family = binomial, data = .x)),
    tidied = map(models, tidy, conf.int = TRUE, exponentiate = TRUE)
  ) %>%
  select(city_state, tidied) %>%
  unnest(tidied) %>%
  filter(term == "victim_sexMale") %>%
  mutate(city_state = fct_reorder(city_state, estimate))
```

```{r city-plot, fig.height=8, fig.width=7}
city_results %>%
  ggplot(aes(x = city_state, y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "red") +
  coord_flip() +
  labs(
    x = "City",
    y = "Adjusted OR (Male vs Female)",
    title = "Adjusted odds ratios for homicide resolution by city"
  )
```

The odds ratios vary widely by city; several cities show higher resolution odds for cases with male victims, while a few cities have estimates near or below 1, indicating similar or lower resolution odds compared with female victims. Uncertainty is substantial for smaller cities, as reflected by wide intervals.

## Problem 2
```{r}
library(tidyverse)
library(broom)
library(p8105.datasets)

set.seed(123)

n_boot <- 5000

# Load data
data("weather_df")

# Generate bootstrap estimates for R^2 and beta1*beta2
boot_estimates <- map_dfr(1:n_boot, function(i) {
  boot_sample <- sample_frac(weather_df, size = 1, replace = TRUE)
  fit <- lm(tmax ~ tmin + prcp, data = boot_sample)
  glance_df <- glance(fit)
  tidy_df <- tidy(fit)

  beta1 <- tidy_df %>% filter(term == "tmin") %>% pull(estimate)
  beta2 <- tidy_df %>% filter(term == "prcp") %>% pull(estimate)

  tibble(
    r_squared = glance_df$r.squared,
    beta1_beta2 = beta1 * beta2
  )
})

# Calculate confidence intervals
ci_summary <- tibble(
  measure = c("R_squared", "beta1_beta2"),
  lower = c(quantile(boot_estimates$r_squared, 0.025),
            quantile(boot_estimates$beta1_beta2, 0.025)),
  upper = c(quantile(boot_estimates$r_squared, 0.975),
            quantile(boot_estimates$beta1_beta2, 0.975))
)

print(ci_summary)

# Plot distributions
estimate_plot <- boot_estimates %>%
  pivot_longer(cols = everything(), names_to = "measure", values_to = "value") %>%
  mutate(measure = recode(measure,
                          r_squared = "R-squared",
                          beta1_beta2 = "beta1 * beta2")) %>%
  ggplot(aes(x = value)) +
  geom_density(fill = "#2c7fb8", alpha = 0.6, color = NA) +
  facet_wrap(~measure, scales = "free") +
  labs(title = "Bootstrap distributions for Central Park weather regression",
       x = "Estimate", y = "Density") +
  theme_minimal()

ggsave("bootstrap_estimates.png", estimate_plot, width = 8, height = 4, dpi = 300)
```


## Problem 3

```{r packages-p3}
library(ggplot2)
library(modelr)
```

### Data cleaning

```{r clean-birthweight}
birthweight_df <- read_csv("data/birthweight.csv") %>%
  mutate(
    babysex = factor(babysex, levels = c(1, 2), labels = c("male", "female")),
    frace = factor(frace),
    mrace = factor(mrace),
    malform = factor(malform),
    frace = fct_recode(frace, "White" = "1", "Black" = "2", "Asian" = "3", "Puerto Rican" = "4", "Other" = "8", "Unknown" = "9"),
    mrace = fct_recode(mrace, "White" = "1", "Black" = "2", "Asian" = "3", "Puerto Rican" = "4", "Other" = "8")
  )

birthweight_df %>%
  summarize(total_missing = sum(is.na(.)))
```

No missing values are present in the dataset.

### Proposed model

I built a model focused on infant size and maternal health factors, hypothesizing that gestational development and maternal characteristics drive birthweight. The model includes baby head circumference and length, gestational age, maternal age, pre-pregnancy BMI, weight gain during pregnancy, smoking, and family income:

```{r proposed-model}
model_main <- lm(bwt ~ bhead + blength + gaweeks + ppbmi + wtgain + momage + smoken + fincome, data = birthweight_df)

tidy(model_main)
```

### Residual diagnostics

```{r residuals-plot, fig.height=4.5, fig.width=7}
resid_plot_df <- birthweight_df %>%
  add_predictions(model_main) %>%
  add_residuals(model_main)

resid_plot_df %>%
  ggplot(aes(x = pred, y = resid)) +
  geom_point(alpha = 0.4) +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  labs(
    x = "Fitted values",
    y = "Residuals",
    title = "Residuals vs fitted values for proposed birthweight model"
  )
```

### Model comparison

```{r comparison}
set.seed(1234)

cv_df <- crossv_mc(birthweight_df, n = 100)

cv_results <- cv_df %>%
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble),
    fit_main = map(train, ~ lm(bwt ~ bhead + blength + gaweeks + ppbmi + wtgain + momage + smoken + fincome, data = .x)),
    fit_simple = map(train, ~ lm(bwt ~ blength + gaweeks, data = .x)),
    fit_interaction = map(train, ~ lm(bwt ~ bhead * blength * babysex, data = .x)),
    rmse_main = map2_dbl(fit_main, test, ~ rmse(model = .x, data = .y)),
    rmse_simple = map2_dbl(fit_simple, test, ~ rmse(model = .x, data = .y)),
    rmse_interaction = map2_dbl(fit_interaction, test, ~ rmse(model = .x, data = .y))
  )

cv_results %>%
  select(starts_with("rmse")) %>%
  pivot_longer(everything(), names_to = "model", values_to = "rmse") %>%
  mutate(model = recode(model,
                        rmse_main = "Proposed model",
                        rmse_simple = "Length + gestational age",
                        rmse_interaction = "Head + length + sex (interactions)")) %>%
  ggplot(aes(x = model, y = rmse)) +
  geom_boxplot() +
  labs(
    x = "Model",
    y = "RMSE",
    title = "Cross-validated RMSE across models"
  ) +
  theme(axis.text.x = element_text(angle = 15, hjust = 1))
```

The proposed model shows lower cross-validated RMSE than the simpler gestational-age model and performs comparably to or slightly better than the fully interactive head/length/sex model, suggesting it balances predictive accuracy with parsimony.
